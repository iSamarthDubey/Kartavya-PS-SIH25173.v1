build:
  builder: nixpacks

deploy:
  startCommand: |
    # Install dependencies
    pip install -r backend/requirements.txt
    pip install -e cli/
    
    # Start both services
    python -c "
    import subprocess
    import threading
    import time
    import os
    
    def start_backend():
        os.environ['API_HOST'] = '0.0.0.0'
        os.environ['API_PORT'] = '8000' 
        os.environ['ENVIRONMENT'] = 'production'
        os.chdir('backend')
        subprocess.run(['python', 'main.py'])
    
    def start_web():
        time.sleep(8)
        from fastapi import FastAPI
        from fastapi.responses import HTMLResponse
        import uvicorn
        
        app = FastAPI(title='Kartavya SIEM')
        
        @app.get('/', response_class=HTMLResponse)
        def dashboard():
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>ðŸ”’ Kartavya SIEM</title></head>
            <body style=\"font-family: system-ui; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;\">
                <div style=\"text-align: center; max-width: 800px; padding: 40px;\">
                    <h1 style=\"font-size: 4em; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);\">ðŸ”’ Kartavya SIEM</h1>
                    <p style=\"font-size: 1.5em; margin-bottom: 40px; opacity: 0.9;\">AI-Powered Security Information and Event Management</p>
                    
                    <div style=\"display: flex; justify-content: center; gap: 20px; margin: 40px 0; flex-wrap: wrap;\">
                        <div style=\"background: rgba(255,255,255,0.1); padding: 15px 25px; border-radius: 25px; backdrop-filter: blur(10px);\">
                            <div style=\"width: 12px; height: 12px; border-radius: 50%; background: #4CAF50; margin: 0 auto 5px; animation: pulse 2s infinite;\"></div>
                            Backend API
                        </div>
                        <div style=\"background: rgba(255,255,255,0.1); padding: 15px 25px; border-radius: 25px; backdrop-filter: blur(10px);\">
                            <div style=\"width: 12px; height: 12px; border-radius: 50%; background: #4CAF50; margin: 0 auto 5px; animation: pulse 2s infinite;\"></div>
                            CLI Interface
                        </div>
                    </div>
                    
                    <div style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 40px 0;\">
                        <a href=\"/api/docs\" style=\"background: rgba(255,255,255,0.15); padding: 30px; border-radius: 15px; text-decoration: none; color: white; transition: transform 0.3s;\">
                            <h3>ðŸ“Š API Documentation</h3>
                            <p>Interactive API docs</p>
                        </a>
                        <a href=\"/health\" style=\"background: rgba(255,255,255,0.15); padding: 30px; border-radius: 15px; text-decoration: none; color: white; transition: transform 0.3s;\">
                            <h3>ðŸ’š Health Check</h3>
                            <p>System status</p>
                        </a>
                    </div>
                    
                    <div style=\"background: rgba(0,0,0,0.3); padding: 25px; border-radius: 10px; font-family: monospace; text-align: left; margin: 30px 0;\">
                        <div style=\"color: #4CAF50;\"># CLI Commands:</div>
                        <div style=\"color: #58a6ff;\">pip install kartavya-cli</div>
                        <div style=\"color: #58a6ff;\">kartavya setup</div>
                        <div style=\"color: #58a6ff;\">kartavya chat ask \"show security alerts\"</div>
                    </div>
                    
                    <p style=\"margin-top: 40px; opacity: 0.7;\">
                        ðŸš€ Deployed on Railway â€¢ Full Stack SIEM Solution
                    </p>
                </div>
            </body>
            </html>
            '''
        
        @app.get('/health')
        def health():
            return {'status': 'healthy', 'service': 'kartavya-siem', 'version': '1.0.0'}
            
        # Proxy API requests to backend
        @app.api_route('/api/{path:path}', methods=['GET', 'POST', 'PUT', 'DELETE'])
        async def proxy(path: str, request):
            import httpx
            async with httpx.AsyncClient() as client:
                try:
                    response = await client.request(
                        request.method,
                        f'http://localhost:8000/api/{path}',
                        params=dict(request.query_params),
                        content=await request.body()
                    )
                    return response.json()
                except:
                    return {'error': 'Backend not ready'}
        
        port = int(os.environ.get('PORT', 3000))
        uvicorn.run(app, host='0.0.0.0', port=port)
    
    # Start both services
    backend_thread = threading.Thread(target=start_backend, daemon=True)
    backend_thread.start()
    start_web()
    "

environments:
  production:
    variables:
      ENVIRONMENT: production
      KARTAVYA_API_URL: http://localhost:8000
